#!/bin/bash

GREEN='\033[0;32m'
YELLOW='\033[1;33m'
RED='\033[1;31m'
NC='\033[0m' # No Color

# Store password for sudo commands
PASSWORD="dwemer"

printf ${GREEN}
echo "= Updating Server"
printf ${NC}

cd /var/www/html/HerikaServer
git reset --hard HEAD
git pull
# Set permissions for HerikaServer immediately after updating
echo $PASSWORD | sudo -S chown -R dwemer:www-data /var/www/html/HerikaServer
echo $PASSWORD | sudo -S chmod -R 775 /var/www/html/HerikaServer

printf ${GREEN}
echo "= Updating MiniMe"
printf ${NC}

cd /home/dwemer/minime-t5
# Force clean untracked files
git clean -fd
git reset --hard HEAD
git pull
# Set permissions for minime-t5
sudo chown -R dwemer:dwemer /home/dwemer/minime-t5
sudo chmod -R 755 /home/dwemer/minime-t5

printf ${GREEN}
echo "= Updating MeloTTS"
printf ${NC}
cd /home/dwemer/MeloTTS
# Force clean untracked files
git clean -fd
git reset --hard HEAD
git pull
# Set permissions for MeloTTS
sudo chown -R dwemer:dwemer /home/dwemer/MeloTTS
sudo chmod -R 755 /home/dwemer/MeloTTS

printf ${GREEN}
echo "= Updating LocalWhisper"
printf ${NC}
cd /home/dwemer/remote-faster-whisper

# Check current remote URL
CURRENT_REMOTE=$(git config --get remote.origin.url)
TARGET_REMOTE="https://github.com/abeiro/remote-faster-whisper.git"

# Set the correct remote if needed
if [ "$CURRENT_REMOTE" != "$TARGET_REMOTE" ]; then
    printf ${YELLOW}
    echo "Setting remote to $TARGET_REMOTE"
    printf ${NC}
    git remote set-url origin $TARGET_REMOTE
fi

# Force clean untracked files
git clean -fd
git reset --hard HEAD
git pull
# Set permissions for LocalWhisper
sudo chown -R dwemer:dwemer /home/dwemer/remote-faster-whisper
sudo chmod -R 755 /home/dwemer/remote-faster-whisper

printf ${GREEN}
echo "= Updating XTTSv2 server"
printf ${NC}
cd /home/dwemer/xtts-api-server

# Backup speakers folder if it exists
if [ -d "speakers" ]; then
    printf ${YELLOW}
    echo "Backing up speakers folder..."
    printf ${NC}
    cp -r speakers speakers.backup
fi

# Exclude speakers folder from cleaning if it exists
if [ -d "speakers" ]; then
    # Force clean everything except speakers folder
    git clean -fd -e speakers/
else
    # Force clean all untracked files
    git clean -fd
fi

git reset --hard HEAD
git pull

# Restore speakers folder if backup exists
if [ -d "speakers.backup" ]; then
    printf ${YELLOW}
    echo "Restoring speakers folder..."
    printf ${NC}
    cp -r speakers.backup/* speakers/ 2>/dev/null || true
    rm -rf speakers.backup
fi

# Set permissions for XTTS
sudo chown -R dwemer:dwemer /home/dwemer/xtts-api-server
sudo chmod -R 755 /home/dwemer/xtts-api-server

# Also run the update_perms script for any other locations
printf ${GREEN}
echo "= Running system permission updates..."
printf ${NC}
sudo /usr/local/bin/update_perms

printf ${GREEN}
echo "Done!"
printf ${NC}
