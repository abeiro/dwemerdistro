#!/bin/bash

# Simplified color palette - only red and green for specific cases
GREEN='\033[0;32m'
RED='\033[1;31m'
BOLD='\033[1m'
NC='\033[0m' # No Color

# Store password for sudo commands
PASSWORD="dwemer"

# Helper function for section headers
print_header() {
    local title="$1"
    local branch=""
    
    # Check if second parameter (branch) is provided
    if [ ! -z "$2" ]; then
        branch=" ($2)"
    fi
    
    printf "\n${BOLD}-------------------------------------------------------${NC}\n"
    printf "${BOLD} %s%s ${NC}\n" "$title" "$branch"
    printf "${BOLD}-------------------------------------------------------${NC}\n"
}

# Helper function for completion messages
print_success() {
    printf "${GREEN}[SUCCESS] %s${NC}\n" "$1"
}

print_warning() {
    printf "${RED}[WARNING] %s${NC}\n" "$1"
}

# Main title
printf "\n${BOLD}=======================================================${NC}\n"
printf "${BOLD}          DWEMER DYNAMICS SYSTEM UPDATE                ${NC}\n"
printf "${BOLD}=======================================================${NC}\n\n"

# Server update
cd /var/www/html/HerikaServer
BRANCH=$(git branch --show-current)
print_header "UPDATING CHIM SERVER" "$BRANCH"

printf ">> Resetting repository...\n"
git reset --hard HEAD
printf ">> Pulling latest changes...\n"
git pull
# Set permissions for HerikaServer immediately after updating
echo $PASSWORD | sudo -S chown -R dwemer:www-data /var/www/html/HerikaServer
echo $PASSWORD | sudo -S chmod -R 775 /var/www/html/HerikaServer
printf "${GREEN}[SUCCESS] Server updated successfully${NC}\n"

# MiniMe update
cd /home/dwemer/minime-t5
BRANCH=$(git branch --show-current)
print_header "UPDATING MINI-ME & TXT2VEC" "$BRANCH"

printf ">> Resetting repository...\n"
git reset --hard HEAD
printf ">> Pulling latest changes...\n"
git pull

# Set permissions for minime-t5
sudo chown -R dwemer:dwemer /home/dwemer/minime-t5
sudo chmod -R 755 /home/dwemer/minime-t5
printf "${GREEN}[SUCCESS] MiniMe & TXT2VEC updated successfully${NC}\n"

# MeloTTS update
cd /home/dwemer/MeloTTS
BRANCH=$(git branch --show-current)
print_header "UPDATING MELO-TTS" "$BRANCH"

printf ">> Resetting repository...\n"
git reset --hard HEAD
printf ">> Pulling latest changes...\n"
git pull

# Set permissions for MeloTTS
sudo chown -R dwemer:dwemer /home/dwemer/MeloTTS
sudo chmod -R 755 /home/dwemer/MeloTTS
printf "${GREEN}[SUCCESS] MeloTTS updated successfully${NC}\n"

# LocalWhisper update
cd /home/dwemer/remote-faster-whisper
BRANCH=$(git branch --show-current)
print_header "UPDATING LOCALWHISPER" "$BRANCH"

# Check current remote URL
CURRENT_REMOTE=$(git config --get remote.origin.url)
TARGET_REMOTE="https://github.com/abeiro/remote-faster-whisper.git"

# Set the correct remote if needed
if [ "$CURRENT_REMOTE" != "$TARGET_REMOTE" ]; then
    print_warning "Setting remote to $TARGET_REMOTE"
    git remote set-url origin $TARGET_REMOTE
fi

printf ">> Resetting repository...\n"
git reset --hard HEAD
printf ">> Pulling latest changes...\n"
git pull

# Set permissions for LocalWhisper
sudo chown -R dwemer:dwemer /home/dwemer/remote-faster-whisper
sudo chmod -R 755 /home/dwemer/remote-faster-whisper
printf "${GREEN}[SUCCESS] LocalWhisper updated successfully${NC}\n"

# Piper TTS update/setup
# Check if piper directory exists and has README.md
if [ ! -d "/home/dwemer/piper" ] || [ ! -f "/home/dwemer/piper/README.md" ]; then
    print_header "SETTING UP PIPER TTS"
    print_warning "Piper TTS not found or incomplete. Cloning repository..."
    
    # Create directory if it doesn't exist
    if [ ! -d "/home/dwemer/piper" ]; then
        mkdir -p /home/dwemer/piper
    fi
    
    cd /home/dwemer
    # Remove directory if it exists but doesn't have README.md (incomplete clone)
    if [ -d "piper" ] && [ ! -f "piper/README.md" ]; then
        rm -rf piper
    fi
    
    printf ">> Cloning Piper TTS repository...\n"
    git clone -b main https://github.com/Dwemer-Dynamics/Piper-TTS-CHIM.git piper
    
    cd /home/dwemer/piper
else
    # Directory exists with README.md, so update it
    cd /home/dwemer/piper
    BRANCH=$(git branch --show-current)
    print_header "UPDATING PIPER TTS" "$BRANCH"
    
    printf ">> Resetting repository...\n"
    git reset --hard HEAD --quiet
    printf ">> Pulling latest changes...\n"
    git pull
fi

# Set permissions for Piper TTS
sudo chown -R dwemer:dwemer /home/dwemer/piper
sudo chmod -R 755 /home/dwemer/piper
printf "${GREEN}[SUCCESS] Piper TTS updated successfully${NC}\n"

# XTTSv2 server update
cd /home/dwemer/xtts-api-server
BRANCH=$(git branch --show-current)
print_header "UPDATING CHIM XTTS" "$BRANCH"

# Backup speakers folder if it exists
if [ -d "speakers" ]; then
    print_warning "Backing up speakers folder..."
    cp -r speakers speakers.backup
fi

printf ">> Resetting repository...\n"
git reset --hard HEAD
printf ">> Pulling latest changes...\n"
git pull

# Restore speakers folder if backup exists
if [ -d "speakers.backup" ]; then
    print_warning "Restoring speakers folder..."
    cp -r speakers.backup/* speakers/ 2>/dev/null || true
    rm -rf speakers.backup
fi

# Set permissions for XTTS
sudo chown -R dwemer:dwemer /home/dwemer/xtts-api-server
sudo chmod -R 755 /home/dwemer/xtts-api-server
printf "${GREEN}[SUCCESS] CHIM XTTS updated successfully${NC}\n"

# Parakeet update
if [ ! -d /home/dwemer/parakeet-api-server ];then
    cd /home/dwemer/
    git clone https://github.com/Dwemer-Dynamics/parakeet-api-server
fi
cd /home/dwemer/parakeet-api-server
BRANCH=$(git branch --show-current)
print_header "UPDATING PARAKEET" "$BRANCH"

# Check current remote URL
CURRENT_REMOTE=$(git config --get remote.origin.url)
TARGET_REMOTE="https://github.com/Dwemer-Dynamics/parakeet-api-server"

# Set the correct remote if needed
if [ "$CURRENT_REMOTE" != "$TARGET_REMOTE" ]; then
    print_warning "Setting remote to $TARGET_REMOTE"
    git remote set-url origin $TARGET_REMOTE
fi

printf ">> Resetting repository...\n"
git reset --hard HEAD
printf ">> Pulling latest changes...\n"
git pull

# Set permissions for Parakeet
sudo chown -R dwemer:dwemer /home/dwemer/parakeet-api-server
sudo chmod -R 755 /home/dwemer/parakeet-api-server
printf "${GREEN}[SUCCESS] Parakeet updated successfully${NC}\n"

# Chatterbox update/install
if [ ! -d /home/dwemer/chatterbox ];then
    cd /home/dwemer/
    git clone https://github.com/Dwemer-Dynamics/chatterbox
fi
cd /home/dwemer/chatterbox
BRANCH=$(git branch --show-current)
print_header "UPDATING CHATTERBOX" "$BRANCH"

# Check current remote URL
CURRENT_REMOTE=$(git config --get remote.origin.url)
TARGET_REMOTE="https://github.com/Dwemer-Dynamics/chatterbox"

# Set the correct remote if needed
if [ "$CURRENT_REMOTE" != "$TARGET_REMOTE" ]; then
    print_warning "Setting remote to $TARGET_REMOTE"
    git remote set-url origin $TARGET_REMOTE
fi

printf ">> Resetting repository...\n"
git reset --hard HEAD
printf ">> Pulling latest changes...\n"
git pull

# Set permissions for CHATTERBOX
sudo chown -R dwemer:dwemer /home/dwemer/chatterbox
sudo chmod -R 755 /home/dwemer/chatterbox
printf "${GREEN}[SUCCESS] Chatterbox updated successfully${NC}\n"

# PocketTTS update
if [ ! -d /home/dwemer/pocket-tts ];then
    cd /home/dwemer/
    git clone https://github.com/Dwemer-Dynamics/pocket-tts
fi
cd /home/dwemer/pocket-tts
BRANCH=$(git branch --show-current)
print_header "UPDATING pocket-tts" "$BRANCH"

# Check current remote URL
CURRENT_REMOTE=$(git config --get remote.origin.url)
TARGET_REMOTE="https://github.com/Dwemer-Dynamics/pocket-tts"

# Set the correct remote if needed
if [ "$CURRENT_REMOTE" != "$TARGET_REMOTE" ]; then
    print_warning "Setting remote to $TARGET_REMOTE"
    git remote set-url origin $TARGET_REMOTE
fi

printf ">> Resetting repository...\n"
git reset --hard HEAD
printf ">> Pulling latest changes...\n"
git pull

# Set permissions for LocalWhisper
sudo chown -R dwemer:dwemer /home/dwemer/pocket-tts
sudo chmod -R 755 /home/dwemer/pocket-tts
printf "${GREEN}[SUCCESS] Parakeet updated successfully${NC}\n"

# CHIM MCP Server update/install
if [ ! -d /home/dwemer/CHIM-MCP ]; then
    print_header "INSTALLING CHIM MCP SERVER"
    cd /home/dwemer/
    git clone https://github.com/Dwemer-Dynamics/CHIM-MCP.git
fi

if [ -d /home/dwemer/CHIM-MCP ]; then
    mcp_failed=0
    cd /home/dwemer/CHIM-MCP
    BRANCH=$(git branch --show-current)
    print_header "UPDATING CHIM MCP SERVER" "$BRANCH"
    
    printf ">> Resetting repository...\n"
    if ! git reset --hard HEAD; then
        print_warning "CHIM MCP reset failed."
        mcp_failed=1
    fi
    printf ">> Pulling latest changes...\n"
    if ! git pull; then
        print_warning "CHIM MCP pull failed."
        mcp_failed=1
    fi
    
    # Install/update npm dependencies and build
    if [ -f "package.json" ]; then
        refresh_node_paths() {
            npm_path=$(command -v npm 2>/dev/null || true)
            node_path=$(command -v node 2>/dev/null || true)
        }

        windows_node_toolchain_detected() {
            [ -z "$npm_path" ] || [ -z "$node_path" ] || [[ "$npm_path" == /mnt/c/* ]] || [[ "$npm_path" == *.cmd ]] || [[ "$node_path" == /mnt/c/* ]] || [[ "$node_path" == *.exe ]]
        }

        refresh_node_paths
        node_toolchain_ready=1

        if windows_node_toolchain_detected; then
            print_warning "CHIM MCP resolved missing/Windows npm-node inside WSL. Attempting Linux nodejs/npm install."
            if ! echo $PASSWORD | sudo -S apt-get update || ! echo $PASSWORD | sudo -S apt-get -y install nodejs npm; then
                print_warning "CHIM MCP could not auto-install Linux nodejs/npm."
                node_toolchain_ready=0
                mcp_failed=1
            else
                refresh_node_paths
                if windows_node_toolchain_detected; then
                    print_warning "CHIM MCP still resolves to missing/Windows npm-node after install."
                    print_warning "Ensure WSL PATH prefers /usr/bin for node/npm."
                    node_toolchain_ready=0
                    mcp_failed=1
                fi
            fi
        fi

        if [ "$node_toolchain_ready" -eq 1 ]; then
            export PATH="/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin:$PATH"

            install_success=0
            for attempt in 1 2; do
                printf ">> Installing dependencies...\n"
                if [ -f "package-lock.json" ]; then
                    npm ci && install_success=1 && break
                else
                    npm install && install_success=1 && break
                fi
                if [ "$attempt" -eq 1 ]; then
                    print_warning "CHIM MCP dependency install failed. Retrying after cleanup."
                    rm -rf node_modules
                fi
            done

            if [ "$install_success" -eq 0 ]; then
                print_warning "CHIM MCP dependency install failed after retry."
                mcp_failed=1
            fi

            if [ "$mcp_failed" -eq 0 ]; then
                build_success=0
                for attempt in 1 2; do
                    printf ">> Building TypeScript...\n"
                    npm run build && build_success=1 && break
                    if [ "$attempt" -eq 1 ]; then
                        print_warning "CHIM MCP TypeScript build failed. Retrying once."
                    fi
                done
                if [ "$build_success" -eq 0 ]; then
                    print_warning "CHIM MCP TypeScript build failed after retry."
                    mcp_failed=1
                fi
            fi

            if [ "$mcp_failed" -eq 0 ] && [ ! -f "dist/index.js" ]; then
                print_warning "CHIM MCP build did not produce dist/index.js"
                mcp_failed=1
            fi
        fi
    else
        print_warning "CHIM MCP package.json not found. Skipping MCP build."
        mcp_failed=1
    fi
    
    # Set permissions
    sudo chown -R dwemer:dwemer /home/dwemer/CHIM-MCP
    sudo chmod -R 755 /home/dwemer/CHIM-MCP
    if [ "$mcp_failed" -eq 0 ]; then
        printf "${GREEN}[SUCCESS] CHIM MCP Server updated successfully${NC}\n"
    else
        print_warning "CHIM MCP update had warnings and was not fully completed. Continuing."
    fi
fi

# System permission updates
print_header "RUNNING SYSTEM PERMISSION UPDATES"

sudo /usr/local/bin/update_perms
printf "${GREEN}[SUCCESS] System permissions updated${NC}\n"

# Install netcat, needed for service daemon
sudo apt-get update && sudo apt-get -y install netcat-openbsd

# Final message
printf "\n${BOLD}=======================================================${NC}\n"
printf "${BOLD}${GREEN}                ALL UPDATES COMPLETED!               ${NC}\n"
printf "${BOLD}=======================================================${NC}\n\n"
