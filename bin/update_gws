#!/bin/bash

# Enhanced color palette
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
RED='\033[1;31m'
BLUE='\033[0;34m'
PURPLE='\033[0;35m'
CYAN='\033[0;36m'
BOLD='\033[1m'
NC='\033[0m' # No Color

# Store password for sudo commands
PASSWORD="dwemer"

# Helper function for section headers
print_header() {
    printf "\n${BOLD}${BLUE}-------------------------------------------------------${NC}\n"
    printf "${BOLD}${PURPLE} %s ${NC}\n" "$1"
    printf "${BLUE}-------------------------------------------------------${NC}\n"
}

# Helper function for completion messages
print_success() {
    printf "${GREEN}[SUCCESS] %s${NC}\n" "$1"
}

print_warning() {
    printf "${YELLOW}[WARNING] %s${NC}\n" "$1"
}

# Main title
printf "\n${BOLD}${CYAN}=======================================================${NC}\n"
printf "${BOLD}${CYAN}          DWEMER DYNAMICS SYSTEM UPDATE                ${NC}\n"
printf "${BOLD}${CYAN}=======================================================${NC}\n\n"

# Server update
print_header "UPDATING CHIM SERVER"

cd /var/www/html/HerikaServer
printf "${CYAN}>> Resetting repository...${NC}\n"
git reset --hard HEAD
printf "${CYAN}>> Pulling latest changes...${NC}\n"
git pull
# Set permissions for HerikaServer immediately after updating
echo $PASSWORD | sudo -S chown -R dwemer:www-data /var/www/html/HerikaServer
echo $PASSWORD | sudo -S chmod -R 775 /var/www/html/HerikaServer
printf "${GREEN}[SUCCESS] Server updated successfully${NC}\n"

# MiniMe update
print_header "UPDATING MINI-ME & TXT2VEC"

cd /home/dwemer/minime-t5
printf "${CYAN}>> Cleaning untracked files...${NC}\n"
git clean -fd
printf "${CYAN}>> Resetting repository...${NC}\n"
git reset --hard HEAD
printf "${CYAN}>> Pulling latest changes...${NC}\n"
git pull
# Set permissions for minime-t5
sudo chown -R dwemer:dwemer /home/dwemer/minime-t5
sudo chmod -R 755 /home/dwemer/minime-t5
printf "${GREEN}[SUCCESS] MiniMe updated successfully${NC}\n"

# MeloTTS update
print_header "UPDATING MELOTTS"

cd /home/dwemer/MeloTTS
printf "${CYAN}>> Cleaning untracked files...${NC}\n"
git clean -fd
printf "${CYAN}>> Resetting repository...${NC}\n"
git reset --hard HEAD
printf "${CYAN}>> Pulling latest changes...${NC}\n"
git pull
# Set permissions for MeloTTS
sudo chown -R dwemer:dwemer /home/dwemer/MeloTTS
sudo chmod -R 755 /home/dwemer/MeloTTS
printf "${GREEN}[SUCCESS] MeloTTS updated successfully${NC}\n"

# LocalWhisper update
print_header "UPDATING LOCALWHISPER"

cd /home/dwemer/remote-faster-whisper

# Check current remote URL
CURRENT_REMOTE=$(git config --get remote.origin.url)
TARGET_REMOTE="https://github.com/abeiro/remote-faster-whisper.git"

# Set the correct remote if needed
if [ "$CURRENT_REMOTE" != "$TARGET_REMOTE" ]; then
    print_warning "Setting remote to $TARGET_REMOTE"
    git remote set-url origin $TARGET_REMOTE
fi

printf "${CYAN}>> Cleaning untracked files...${NC}\n"
git clean -fd
printf "${CYAN}>> Resetting repository...${NC}\n"
git reset --hard HEAD
printf "${CYAN}>> Pulling latest changes...${NC}\n"
git pull
# Set permissions for LocalWhisper
sudo chown -R dwemer:dwemer /home/dwemer/remote-faster-whisper
sudo chmod -R 755 /home/dwemer/remote-faster-whisper
printf "${GREEN}[SUCCESS] LocalWhisper updated successfully${NC}\n"

# XTTSv2 server update
print_header "UPDATING CHIM XTTS"

cd /home/dwemer/xtts-api-server

# Backup speakers folder if it exists
if [ -d "speakers" ]; then
    print_warning "Backing up speakers folder..."
    cp -r speakers speakers.backup
fi

# Exclude speakers folder from cleaning if it exists
if [ -d "speakers" ]; then
    printf "${CYAN}>> Cleaning files (preserving speakers folder)...${NC}\n"
    # Force clean everything except speakers folder
    git clean -fd -e speakers/
else
    printf "${CYAN}>> Cleaning untracked files...${NC}\n"
    # Force clean all untracked files
    git clean -fd
fi

printf "${CYAN}>> Resetting repository...${NC}\n"
git reset --hard HEAD
printf "${CYAN}>> Pulling latest changes...${NC}\n"
git pull

# Restore speakers folder if backup exists
if [ -d "speakers.backup" ]; then
    print_warning "Restoring speakers folder..."
    cp -r speakers.backup/* speakers/ 2>/dev/null || true
    rm -rf speakers.backup
fi

# Set permissions for XTTS
sudo chown -R dwemer:dwemer /home/dwemer/xtts-api-server
sudo chmod -R 755 /home/dwemer/xtts-api-server
printf "${GREEN}[SUCCESS] XTTSv2 server updated successfully${NC}\n"

# System permission updates
print_header "RUNNING SYSTEM PERMISSION UPDATES"

sudo /usr/local/bin/update_perms
printf "${GREEN}[SUCCESS] System permissions updated${NC}\n"

# Final message
printf "\n${BOLD}${GREEN}=======================================================${NC}\n"
printf "${BOLD}${GREEN}                ALL UPDATES COMPLETED!               ${NC}\n"
printf "${BOLD}${GREEN}=======================================================${NC}\n\n"
